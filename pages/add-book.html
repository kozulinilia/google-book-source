<!DOCTYPE html>
<div data-id="<?= pageId ?>">
    <div class="card shadow p-4">
        <h4 class="mb-4">
            Добавить книгу
        </h4>
        <label>Новый номер</label>
        <span data-id="new-book-id"></span>
        <div data-id="new-book-button" class="row g-3" align-items-end>
            <div class="col-md-3 float-right">
                <button class="btn btn-primary" data-action="addNewBook">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;">search</span>
                    Новая книга
                </button>
            </div>
        </div>
        <div class="row g-3" data-id="add-book-block" style="display: none" align-items-end>
            <div class="col-md-3">
                <label class="material-label">Автор</label>
                <input data-id="new-author" class="form-control" type="text"></input>
            </div>
            <div class="col-md-3">
                <label class="material-label">Название</label>
                <input data-id="new-name" class="form-control" type="text"></input>
            </div>
            <div class="col-md-3">
                <label class="material-label">Год</label>
                <input data-id="new-year" class="form-control" type="number"></input>
            </div>
            <div class="col-md-3">
                <label class="material-label">Аннотация</label>
                <input data-id="new-annotation" class="form-control" type="text"></input>
            </div>
            <div class="col-md-3">
                <label class="material-label">Номер коробки</label>
                <input data-id="new-box-num" class="form-control" type="number"></input>
            </div>
            <div class="col-md-3">
                <label class="material-label">Рубрика</label>
                <select data-id="new-theme" class="form-select">
                </select>
            </div>
            <div class="row g-3" align-items-end>
                <div class="col-md-3 float-right">
                    <button class="btn btn-primary" data-action="saveNewBook">
                        <span class="material-icons" style="font-size:18px;vertical-align:middle;">search</span>
                        Сохранить
                    </button>
                    <button class="btn btn-danger" data-action="cancelNewBook">
                        <span class="material-icons" style="font-size:18px;vertical-align:middle;">search</span>
                        Отмена
                    </button>
                </div>
            </div>
            <span data-id="error-field" style="color: crimson;display: none"></span>
        </div>
    </div>
    <div data-id="log-list"></div>
</div>
<?!= include('components/variable-container') ?>
<script>
    (function (ns) {
        const pageId = "<?= pageId ?>"
        let root = null
        let loaderEl = null
        let vars = null

        function init(loader = null) {
            root = document.querySelector(`[data-id="${pageId}"]`)
            if (!ns.VarContainer) {
                console.error('VarContainer not initialized');
                return;
            }
            vars = ns.VarContainer.create(root)
            loaderEl = loader
            root.addEventListener('click', clickHandler)
            google.script.run.withSuccessHandler(data => {
                populateDropdowns(data, "newTheme");
            }).getFullThemes();
        }

        function addNewBook() {
            loaderEl.show()
            google.script.run.withSuccessHandler(id => {
                vars.get("new-book-id").set(id)
                vars.get("add-book-block").show()
                vars.get("new-book-button").hide()
                loaderEl.hide()
            }).addNewBook();
        }

        function clickHandler(event) {
            const action = event.target.dataset.action
            switch (action) {
                case 'saveNewBook':
                    saveNewBook()
                    break
                case 'cancelNewBook':
                    cancelNewBook()
                    break
                case 'addNewBook':
                    addNewBook()
                    break
                default:
                    console.error('[clickHandler] Unknown action ' + action)
            }
        }

        function saveNewBook() {
            loaderEl.show()
            const book = {
                author: vars.get("new-author").get(),
                name: vars.get("new-name").get(),
                year: vars.get("new-year").get(),
                annotation: vars.get("new-annotation").get(),
                boxNum: vars.get("new-box-num").get(),
                id: vars.get("new-book-id").get(),
                theme: vars.get("new-theme").get(),
            };
            google.script.run.withSuccessHandler(result => {
                if (result) {
                    addLog(`${book.name} ${book.id}`);
                    clearAddFields();
                    vars.get("add-book-block").hide()
                    vars.get("new-book-button").show()
                    vars.get("new-book-id").set('')
                    loaderEl.hide()
                    showError("", false);
                }
            })
                .withFailureHandler(error => {
                    showError(error, true);
                    loaderEl.hide()
                })
                .saveNewBook(book);
        }

        function cancelNewBook() {
            loaderEl.show()
            let bookId = vars.get("new-book-id").get()
            google.script.run.withSuccessHandler(result => {
                clearAddFields();
                vars.get("add-book-block").hide()
                vars.get("new-book-button").show()
                loaderEl.hide()
            })
                .removeRowById(bookId)
        }

        function clearAddFields() {
            vars.get("new-author").set('')
            vars.get("new-name").set('')
            vars.get("new-year").set('')
            vars.get("new-annotation").set('')
            vars.get("new-box-num").set('')
            vars.get("new-book-id").set('')
            vars.get("new-theme").set('')
        }

        function showError(error, show) {
            vars.get("error-field").set(error);
            if (show) {
                vars.get("error-field").show()
            } else {
                vars.get("error-field").hide()
            }
        }

        function addLog(id) {
            const newEl = document.createElement("div");
            newEl.innerText = id + " добавлена";
            vars.get("log-list").getElement().appendChild(newEl)
        }

        function destroy() {
            if (root) {
                root.removeEventListener('click', clickHandler)
            }
            if (vars) {
                vars.forEach((value, key) => {
                    value.destroy()
                })
            }
        }

        function populateDropdowns(data) {
            data.forEach(value => {
                const opt = document.createElement("option");
                opt.setAttribute("data-action", "changeFilter")
                opt.value = value
                opt.textContent = value
                vars.get("new-theme").getElement().appendChild(opt)
            });
        }


        ns.AddBook = {
            init,
            destroy,
        };
    })(window.App = window.App || {});
</script>
