<!DOCTYPE html>
<div data-id="<?= pageId ?>">
    <div class="card shadow p-4">
        <h4 class="mb-4">
            Добавить книгу
        </h4>
        <label>Новый номер</label>
        <span data-id="new-book-id"></span>
        <div data-id="new-book-button" class="row g-3" align-items-end>
            <div class="col-md-3 float-right">
                <button class="btn btn-primary" data-action="addNewBook">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;">search</span>
                    Новая книга
                </button>
            </div>
        </div>
        <div class="row g-3" data-id="add-book-block" style="display: none" align-items-end>
            <div class="row g-2">
                <div class="col-md-1">
                    <label class="material-label">Номер</label>
                    <input data-id="new-book-id" class="form-control" disabled></input>
                </div>
                <div class="col-md-3">
                    <label class="material-label">Автор</label>
                    <input list="author-source"  data-id="new-author" class="form-control" type="text"></input>
                    <datalist id="author-source" data-id="author-list"></datalist>
                </div>
                <div class="col-md-4">
                    <label class="material-label">Название</label>
                    <input data-id="new-name" class="form-control" type="text"></input>
                </div>
                <div class="col-md-1">
                    <label class="material-label">Год</label>
                    <input data-id="new-year" class="form-control" type="number"></input>
                </div>
                <div class="col-md-1">
                    <label class="material-label">Коробка</label>
                    <input data-id="new-box-num" class="form-control" type="number"></input>
                </div>
                <div class="col-md-2">
                    <label class="material-label">Рубрика</label>
                    <select data-id="theme-value" data-action="changeTheme" class="form-select"></select>
                    <div data-id="new-theme"></div>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-7">
                    <label class="material-label">Аннотация</label>
                    <textarea rows="5" data-id="new-annotation" class="form-control"></textarea>
                </div>
                <div class="row g-3" align-items-end>
                    <div class="col-md-3 float-right">
                        <button class="btn btn-primary" data-action="saveNewBook">
                            Сохранить
                        </button>
                        <button class="btn btn-danger" data-action="cancelNewBook">
                            Отмена
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <span data-id="error-field" style="color: crimson;display: none"></span>
        <div data-id="log-list"></div>
    </div>
</div>
<script>
    (function (ns) {
        const AUTHOR_BACK_ROW = 5
        const pageId = "<?= pageId ?>"
        let root = null
        let loaderEl = null
        let vars = null

        function init(loader = null) {
            root = document.querySelector(`[data-id="${pageId}"]`)
            if (!ns.VarContainer) {
                console.error('VarContainer not initialized');
                return;
            }
            vars = ns.VarContainer.create(root)
            loaderEl = loader
            root.addEventListener('click', clickHandler)
            root.addEventListener('change', changeHandler)
            google.script.run.withSuccessHandler(data => {
                populateDropdowns(data, "newTheme", "changeFilter");
            }).getFullThemes();
            google.script.run.withSuccessHandler(data => {
                populateDropdowns(data, "author-list", "selectAuthor");
            }).getDropdownValuesByKey(AUTHOR_BACK_ROW)
        }

        function addNewBook() {
            loaderEl.show()
            google.script.run.withSuccessHandler(id => {
                vars.get("new-book-id").set(id)
                vars.get("add-book-block").show()
                vars.get("new-book-button").hide()
                loaderEl.hide()
            }).addNewBook();
        }

        function clickHandler(event) {
            const action = event.target.dataset.action
            switch (action) {
                case 'saveNewBook':
                    saveNewBook()
                    break
                case 'cancelNewBook':
                    cancelNewBook()
                    break
                case 'addNewBook':
                    addNewBook()
                    break
                default:
                    console.error('[clickHandler] Unknown action ' + action)
            }
        }

        const changeHandler = (event) => {
            const action = event.target.dataset.action
            const value = event.target.value
            switch (action) {
                case 'changeTheme':
                    const previousValue = vars.get('new-theme').get()
                    const themes = previousValue ? previousValue.split(', ') : []
                    themes.push(value)
                    vars.get('new-theme').set(themes.join(', '))
                    vars.get('theme-value').set('')
                    break
                case 'selectAuthor':
                    vars.get('new-author').set(value)
                    break;
                default:
                    console.error('[clickHandler] Unknown action ' + action)
            }
        }

        function saveNewBook() {
            loaderEl.show()
            const book = {
                author: vars.get("new-author").get(),
                name: vars.get("new-name").get(),
                year: vars.get("new-year").get(),
                annotation: vars.get("new-annotation").get(),
                boxNum: vars.get("new-box-num").get(),
                id: vars.get("new-book-id").get(),
                theme: vars.get("new-theme").get(),
            };
            google.script.run.withSuccessHandler(result => {
                if (result) {
                    addLog(`${book.name} ${book.id}`);
                    clearAddFields();
                    vars.get("add-book-block").hide()
                    vars.get("new-book-button").show()
                    vars.get("new-book-id").set('')
                    loaderEl.hide()
                    showError("", false);
                }
            })
                .withFailureHandler(error => {
                    showError(error, true);
                    loaderEl.hide()
                })
                .saveNewBook(book);
        }

        function cancelNewBook() {
            loaderEl.show()
            let bookId = vars.get("new-book-id").get()
            google.script.run.withSuccessHandler(result => {
                clearAddFields();
                vars.get("add-book-block").hide()
                vars.get("new-book-button").show()
                loaderEl.hide()
            })
                .removeRowById(bookId)
        }

        function clearAddFields() {
            vars.get("new-author").set('')
            vars.get("new-name").set('')
            vars.get("new-year").set('')
            vars.get("new-annotation").set('')
            vars.get("new-box-num").set('')
            vars.get("new-book-id").set('')
            vars.get("new-theme").set('')
        }

        function showError(error, show) {
            vars.get("error-field").set(error);
            if (show) {
                vars.get("error-field").show()
            } else {
                vars.get("error-field").hide()
            }
        }

        function addLog(id) {
            const newEl = document.createElement("div");
            newEl.innerText = id + " добавлена";
            vars.get("log-list").getElement().appendChild(newEl)
        }

        function destroy() {
            if (root) {
                root.removeEventListener('click', clickHandler)
                root.removeEventListener('change', changeHandler)
            }
            if (vars) {
                vars.forEach((value, key) => {
                    value.destroy()
                })
            }
        }

        function populateDropdowns(data, id, functionName) {
            data.forEach(v => {
                const opt = document.createElement("option");
                opt.setAttribute("data-action", functionName)
                opt.value = v;
                opt.textContent = v;
                vars.get(id).getElement().appendChild(opt);
            });
        }


        ns.AddBook = {
            init,
            destroy,
        };
    })(window.App = window.App || {});
</script>