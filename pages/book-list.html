<!DOCTYPE html>
<div data-id="<?= pageId ?>">
    <div class="card shadow p-4">
        <h4 class="mb-4">
            Список Книг
        </h4>

        <div class="row g-3" align-items-end>
            <div class="col-md-3">
                <label class="material-label">Рубрика</label>
                <select class="form-select" data-id="theme" data-action="changeFilter">
                    <option value="">Все</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="material-label">Поиск по названию</label>
                <input data-id="name" class="form-control" type="text"></input>
            </div>
            <div class="col-md-3">
                <label class="material-label">Поиск по автору</label>
                <input data-id="author" class="form-control" type="text"></input>
            </div>
            <div class="col-md-3 float-right">
                <button class="btn btn-primary" data-action="loadData">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;">search</span>
                    Показать
                </button>
            </div>
        </div>
    </div>

    <div data-component="table" data-id="table1"></div>
    <?!= include('components/custom-table') ?>
    <?!= include('components/variable-container') ?>
</div>
<script>
    (function (ns) {
        let fullData = [];   // Полный набор данных (после фильтра)
        let filteredData = [];
        let headers = [];    // Заголовки
        const pageSize = 20; // Кол-во строк на страницу
        const pageId = "<?= pageId ?>"
        let root = null
        let tableObject = null
        let loaderEl = null
        let vars = null

        function init(loader = null) {
            if (!ns.TableFactory) {
                console.error('TableFactory not initialized');
                return;
            }
            if (!ns.VarContainer) {
                console.error('VarContainer not initialized');
                return;
            }
            root = document.querySelector(`[data-id="${pageId}"]`)
            vars = ns.VarContainer.create(root)
            loaderEl = loader
            root.addEventListener('click', clickHandler)
            root.addEventListener('change', changeHandler)
            loaderEl.show()
            google.script.run.withSuccessHandler(data => {
                populateDropdowns(data, "filterA");
            }).getDropdownValues();
            google.script.run.withSuccessHandler(data => {
                headers = data.header;
                fullData = data.rows;
                filteredData = data.rows;
                const tableElement = root.querySelector(`[data-id="table1"]`)
                tableObject = ns.TableFactory.create(
                    tableElement,
                    headers,
                    customTableFunction,
                    pageSize,
                    filteredData,
                )
                tableObject.render(filteredData)
                loaderEl.hide()
            }).getFilteredData()
        }

        function clickHandler(event) {
            const action = event.target.dataset.action
            if (action === 'loadData') {
                tableObject.skipPage()
                loadData()
            }
        }

        function changeHandler(event) {
            const action = event.target.dataset.action
            if (action === 'changeFilter') {
                vars.get('author').set('')
                vars.get('name').set('')
                tableObject.skipPage()
                loadData()
            }
        }

        function populateDropdowns(data) {
            data.forEach(v => {
                const opt = document.createElement("option");
                opt.setAttribute("data-action", "changeFilter")
                opt.value = v;
                opt.textContent = v;
                vars.get('theme').getElement().appendChild(opt);
            });
        }

        function loadData() {
            filteredData = fullData.filter(item => {
                return item[0]
                    .includes(vars.get('theme').get()) && item[1]
                    .includes(vars.get('author').get()) && item[2]
                    .includes(vars.get('name').get());
            });
            tableObject.render(filteredData)
        }

        function customTableFunction(td, index, cell) {
            if (index === 5) {
                if (cell) {
                    const a = document.createElement("a");
                    a.href = cell;
                    a.textContent = "посмотреть"
                    a.target = "_blank";
                    td.appendChild(a);
                } else {
                    td.textContent = 'нет картинки';
                }

            } else {
                td.textContent = cell;
            }
        }

        function destroy() {
            if (tableObject) {
                tableObject.destroy()
            }
            if (root) {
                root.removeEventListener('click', clickHandler)
                root.removeEventListener('change', changeHandler)
            }
            if (vars) {
                vars.forEach((value, key) => {
                    value.destroy()
                })
            }
        }

        ns.BookList = {
            init,
            reload: loadData,
            destroy,
        };
    })(window.App = window.App || {});
</script>
